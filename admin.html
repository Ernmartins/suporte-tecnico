<script type="module">
import { firebaseConfig } from "./firebase.js";

import { 
  initializeApp 
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";

import { 
  getFirestore, collection, getDocs, doc, updateDoc 
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

// Iniciar Firebase
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

async function carregarTickets() {
  const tbody = document.querySelector("#tabelaTickets tbody");
  tbody.innerHTML = "<tr><td colspan='6'>A carregar...</td></tr>";

  const snap = await getDocs(collection(db, "tickets"));
  tbody.innerHTML = "";

  snap.forEach((documento) => {
    const t = documento.data();
    const idDoc = documento.id; // ID REAL DO FIRESTORE

    const estadoClasse =
      t.estado === "Aberto" ? "aberto" :
      t.estado === "Em andamento" ? "andamento" :
      t.estado === "Resolvido" ? "resolvido" :
      "fechado";

    tbody.innerHTML += `
      <tr>
        <td>${t.id}</td>
        <td>${t.nome}</td>
        <td>${t.categoria}</td>
        <td>${t.prioridade}</td>

        <td>
          <select class="estadoSelect" data-id="${idDoc}">
            <option ${t.estado === "Aberto" ? "selected" : ""}>Aberto</option>
            <option ${t.estado === "Em andamento" ? "selected" : ""}>Em andamento</option>
            <option ${t.estado === "Resolvido" ? "selected" : ""}>Resolvido</option>
            <option ${t.estado === "Fechado" ? "selected" : ""}>Fechado</option>
          </select>
        </td>

        <td>${t.descricao}</td>
      </tr>
    `;
  });

  // Ativar eventos nos dropdowns
  ativarListenersEstado();
}

function ativarListenersEstado() {
  document.querySelectorAll(".estadoSelect").forEach((select) => {
    select.addEventListener("change", async (e) => {
      const novoEstado = e.target.value;
      const docID = e.target.getAttribute("data-id");

      const ref = doc(db, "tickets", docID);
      await updateDoc(ref, { estado: novoEstado });

      alert("Estado atualizado para: " + novoEstado);
    });
  });
}

// Carregar tabela ao abrir a p√°gina
carregarTickets();
</script>

